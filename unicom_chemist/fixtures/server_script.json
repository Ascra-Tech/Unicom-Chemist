[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-14 11:24:54.767771",
  "module": "Unicom Chemist",
  "name": "Sales Order Naming Series",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Order",
  "script": "branch = doc.branch\r\n\r\n\r\nif not branch:\r\n    frappe.throw(\"Branch is mandatory for Sales Invoice\")\r\n\r\nbranch_abbr = frappe.db.get_value(\r\n    \"Branch\",\r\n    branch,\r\n    \"custom_abbr\"\r\n)\r\n\r\nif not branch_abbr:\r\n    frappe.throw(\r\n        f\"Branch abbreviation (custom_abbr) is missing for Branch: {branch}. \"\r\n        \"Please configure it before creating Sales Invoice.\"\r\n    )\r\n\r\n# Branch-wise Sales Invoice naming series\r\ndoc.naming_series = f\"SO-{branch_abbr}-.YY.-.##\"\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-22 15:23:02.586244",
  "module": "Unicom Chemist",
  "name": "Item Barcode",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Item",
  "script": "# After the Item is inserted, create a linked Item Barcode record\nif not doc.barcodes:\n    \n    # Get the highest existing 6-digit barcode\n    last_barcode = frappe.db.sql(\"\"\"\n        SELECT MAX(CAST(barcode AS UNSIGNED)) as max_barcode \n        FROM `tabItem Barcode` \n        WHERE barcode REGEXP '^[0-9]{6}$'\n    \"\"\", as_dict=True)\n    \n    # Calculate the next barcode number\n    if last_barcode and last_barcode[0].max_barcode:\n        next_number = last_barcode[0].max_barcode + 1\n    else:\n        next_number = 100000\n    \n    # Format as 6-digit string\n    barcode = str(next_number).zfill(6)\n    \n    # Check uniqueness\n    while frappe.db.exists(\"Item Barcode\", {\"barcode\": barcode}):\n        next_number += 1\n        barcode = str(next_number).zfill(6)\n    \n    # Create the Item Barcode document\n    barcode_doc = frappe.get_doc({\n        \"doctype\": \"Item Barcode\",\n        \"barcode\": barcode,\n        \"parent\": doc.name,\n        \"parenttype\": \"Item\",\n        \"parentfield\": \"barcodes\",\n        \"uom\": doc.stock_uom\n    })\n    barcode_doc.insert(ignore_permissions=True)\n    \n    # Link it to the item\n    doc.append(\"barcodes\", {\n        \"barcode\": barcode,\n        \"uom\": doc.stock_uom\n    })\n    \n    # Save the item to update the child table\n    doc.save(ignore_permissions=True)\n    \n    frappe.msgprint(f\"Barcode {barcode} has been created and linked to this item.\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-03 13:50:19.573074",
  "module": null,
  "name": "Purchase Receipt Naming Series",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Receipt",
  "script": "# Created By Garima on 1-1-26\r\n# Naming Series for Purchase Receipt using branch abbreviation\r\n\r\nbranch = doc.branch\r\n\r\nif not branch:\r\n    frappe.throw(\"Branch is mandatory for Purchase Receipt\")\r\n\r\nbranch_abbr = frappe.db.get_value(\r\n    \"Branch\",\r\n    branch,\r\n    \"custom_abbr\"\r\n)\r\n\r\nif not branch_abbr:\r\n    frappe.throw(\r\n        f\"Branch abbreviation (custom_abbr) is missing for Branch: {branch}. \"\r\n        \"Please configure it before creating Purchase Receipt.\"\r\n    )\r\n\r\n# Branch-wise Purchase Receipt naming series\r\ndoc.naming_series = f\"PU-{branch_abbr}-.DD.-.MM.-.YY.-.##\"\r\n\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-03 13:37:51.967472",
  "module": null,
  "name": "Purchase Order Naming Series",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Order",
  "script": "# Created By Garima on 1-1-26\r\n# Naming Series for Purchase Order using branch abbreviation\r\n\r\nbranch = doc.branch\r\n\r\nif not branch:\r\n    frappe.throw(\"Branch is mandatory for Purchase Receipt\")\r\n\r\nbranch_abbr = frappe.db.get_value(\r\n    \"Branch\",\r\n    branch,\r\n    \"custom_abbr\"\r\n)\r\n\r\nif not branch_abbr:\r\n    frappe.throw(\r\n        f\"Branch abbreviation (custom_abbr) is missing for Branch: {branch}. \"\r\n        \"Please configure it before creating Purchase Receipt.\"\r\n    )\r\n\r\n# Branch-wise Purchase Receipt naming series\r\ndoc.naming_series = f\"PO-{branch_abbr}-.DD.-.MM.-.YY.-.##\"\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-03 14:03:22.050477",
  "module": null,
  "name": "Quotation Naming Series",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Quotation",
  "script": "branch = doc.custom_branch\r\n\r\n\r\nif not branch:\r\n    frappe.throw(\"Branch is mandatory for Quotation\")\r\n\r\nbranch_abbr = frappe.db.get_value(\r\n    \"Branch\",\r\n    branch,\r\n    \"custom_abbr\"\r\n)\r\n\r\nif not branch_abbr:\r\n    frappe.throw(\r\n        f\"Branch abbreviation (custom_abbr) is missing for Branch: {branch}. \"\r\n        \"Please configure it before creating Sales Invoice.\"\r\n    )\r\n\r\n# Branch-wise Sales Invoice naming series\r\ndoc.naming_series = f\"QU-{branch_abbr}-.DD.-.MM.-.YY.-.##\"\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-03 10:20:12.098114",
  "module": "Unicom Chemist",
  "name": "POS Naming series",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "POS Invoice",
  "script": "branch = doc.branch\r\n\r\n# If branch is coming from POS Profile\r\nif not branch and doc.pos_profile:\r\n    branch = frappe.db.get_value(\r\n        \"POS Profile\",\r\n        doc.pos_profile,\r\n        \"branch\"\r\n    )\r\n\r\nif not branch:\r\n    frappe.throw(\"Branch is mandatory for POS Invoice\")\r\n\r\nbranch_abbr = frappe.db.get_value(\r\n    \"Branch\",\r\n    branch,\r\n    \"custom_abbr\"\r\n)\r\n\r\nif not branch_abbr:\r\n    frappe.throw(\r\n        f\"Branch abbreviation (custom_abbr) is missing for Branch: {branch}. \"\r\n        \"Please configure it before creating POS Invoice.\"\r\n    )\r\n\r\ndoc.naming_series = f\"POS-{branch_abbr}-.YY.-.##\"\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-29 12:40:23.981610",
  "module": "Unicom Chemist",
  "name": "Material Request Branch wise",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Material Request",
  "script": "branches = set()\r\n\r\n# Collect branch from each item row\r\nfor item in doc.items:\r\n    if item.branch:\r\n        branches.add(item.branch)\r\n\r\nif not branches:\r\n    frappe.throw(\r\n        \"Branch is mandatory in Material Request Items \"\r\n        \"(Accounting Dimension).\"\r\n    )\r\n\r\n# ❌ Do not allow multiple branches\r\nif len(branches) > 1:\r\n    frappe.throw(\r\n        \"All items in a Material Request must belong to the same Branch.\"\r\n    )\r\n\r\nbranch = branches.pop()\r\n\r\n# Get branch abbreviation\r\nbranch_abbr = frappe.db.get_value(\r\n    \"Branch\",\r\n    branch,\r\n    \"custom_abbr\"\r\n)\r\n\r\nif not branch_abbr:\r\n    frappe.throw(\r\n        f\"Branch abbreviation (custom_abbr) is missing for Branch: {branch}\"\r\n    )\r\n\r\n# Set naming series\r\ndoc.naming_series = f\"MR-{branch_abbr}-.YY.-.##\"\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-03 10:20:12.128615",
  "module": "Unicom Chemist",
  "name": "Item naming series",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Item",
  "script": "# Server Script for Item Auto-Naming\n# Event: Before Insert\n\nif doc.is_new():\n    if not doc.item_group:\n        frappe.throw('Item Group is required')\n    \n    item_group_name = frappe.db.get_value('Item Group', doc.item_group, 'item_group_name')\n    \n    if not item_group_name:\n        frappe.throw('Item Group not found')\n    \n    parts = item_group_name.split('-')\n    \n    if len(parts) >= 2:\n        part1 = parts[0].strip()[:3].upper()\n        part2 = parts[1].strip()[:3].upper()\n        prefix = f'{part1}-{part2}'\n    else:\n        prefix = item_group_name[:6].upper().replace(' ', '').replace('-', '')\n    \n    series_pattern = f'{prefix}-.####'\n    \n    doc.naming_series =series_pattern",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-03 10:20:12.118232",
  "module": "Unicom Chemist",
  "name": "Sales Invoice Naming Series",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "branch = doc.branch\r\n\r\n\r\nif not branch:\r\n    frappe.throw(\"Branch is mandatory for Sales Invoice\")\r\n\r\nbranch_abbr = frappe.db.get_value(\r\n    \"Branch\",\r\n    branch,\r\n    \"custom_abbr\"\r\n)\r\n\r\nif not branch_abbr:\r\n    frappe.throw(\r\n        f\"Branch abbreviation (custom_abbr) is missing for Branch: {branch}. \"\r\n        \"Please configure it before creating Sales Invoice.\"\r\n    )\r\n\r\n# Branch-wise Sales Invoice naming series\r\ndoc.naming_series = f\"SI-{branch_abbr}-.YY.-.##\"\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-03 10:20:12.086775",
  "module": "Unicom Chemist",
  "name": "Purchase Invoice Naming Script",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Purchase Invoice",
  "script": "#Created By Garima on 1-1-26 \r\n#Naming Series for Purchase Invoice using branch abbreviation\r\n\r\nbranch = doc.branch\r\n\r\nif not branch:\r\n    frappe.throw(\"Branch is mandatory for Purchase Invoice\")\r\n\r\nbranch_abbr = frappe.db.get_value(\r\n    \"Branch\",\r\n    branch,\r\n    \"custom_abbr\"\r\n)\r\n\r\nif not branch_abbr:\r\n    frappe.throw(\r\n        f\"Branch abbreviation (custom_abbr) is missing for Branch: {branch}. \"\r\n        \"Please configure it before creating Purchase Invoice.\"\r\n    )\r\n\r\n# Branch-wise Purchase Invoice naming series\r\ndoc.naming_series = f\"PINV-{branch_abbr}-.YY.-.##\"\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-22 19:02:28.645534",
  "module": null,
  "name": "Expiry based discount",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Sales Invoice",
  "script": "for item in doc.items:\r\n    # IMPORTANT: Reset max_discount for EVERY item at the start of the loop\r\n    max_discount = 0\r\n    \r\n    if item.serial_and_batch_bundle:\r\n        # 1. Get the list of Batch Numbers\r\n        entries = frappe.get_all(\"Serial and Batch Entry\", \r\n            filters={\"parent\": item.serial_and_batch_bundle}, \r\n            fields=[\"batch_no\"])\r\n        \r\n        for entry in entries:\r\n            if entry.batch_no:\r\n                expiry_date = frappe.db.get_value(\"Batch\", entry.batch_no, \"expiry_date\")\r\n                \r\n                if expiry_date:\r\n                    today = frappe.utils.getdate(frappe.utils.today())\r\n                    expiry = frappe.utils.getdate(expiry_date)\r\n                    diff = frappe.utils.date_diff(expiry, today)\r\n                    \r\n                    current_discount = 0\r\n                    if diff <= 60:\r\n                        current_discount = 50\r\n                    elif diff <= 90:\r\n                        current_discount = 30\r\n                    \r\n                    # Update max_discount only if this batch has a higher one\r\n                    if current_discount > max_discount:\r\n                        max_discount = current_discount\r\n\r\n    # 3. Apply or RESET results for the Invoice Row\r\n    if max_discount > 0:\r\n        item.discount_percentage = max_discount\r\n        item.ignore_pricing_rule = 1\r\n        \r\n        # Calculate the actual rate\r\n        item.rate = item.price_list_rate * (1 - (max_discount / 100.0))\r\n        item.discount_amount = item.price_list_rate - item.rate\r\n    else:\r\n        # VERY IMPORTANT: If no batch discount applies, \r\n        # ensure we don't leave old discount values from previous saves\r\n        item.discount_percentage = 0\r\n        item.discount_amount = 0\r\n        item.rate = item.price_list_rate\r\n\r\n    # Ensure amount and base fields are updated for the system to \"see\" the change\r\n    item.amount = item.rate * item.qty\r\n    if doc.get(\"conversion_rate\"):\r\n        item.base_rate = item.rate * doc.conversion_rate\r\n        item.base_amount = item.amount * doc.conversion_rate\r\n\r\n    if max_discount > 0:\r\n        frappe.msgprint(f\"Row {item.idx}: Applied {max_discount}% discount for {item.item_code}\")\r\n\r\n# 4. Finalize totals\r\ndoc.calculate_taxes_and_totals()",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2026-01-29 12:48:46.293037",
  "module": "Unicom Chemist",
  "name": "Stock Entry Naming",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Stock Entry",
  "script": "# Run only for Material Transfe\r\nif doc.stock_entry_type == \"Material Transfer\" or doc.stock_entry_type == \"Material Receipt\":\r\n\r\n    branches = set()\r\n\r\n    # Collect Branch from Target Warehouse\r\n    for item in doc.items:\r\n        if not item.t_warehouse:\r\n            frappe.throw(\r\n                \"Target Warehouse is mandatory in Material Transfer Items.\"\r\n            )\r\n\r\n        branch = frappe.db.get_value(\r\n            \"Warehouse\",\r\n            item.t_warehouse,\r\n            \"custom_branch\"\r\n        )\r\n\r\n        if not branch:\r\n            frappe.throw(\r\n                f\"Branch is not set in Target Warehouse: {item.t_warehouse}\"\r\n            )\r\n\r\n        branches.add(branch)\r\n\r\n    # Safety check\r\n    if not branches:\r\n        frappe.throw(\r\n            \"Branch could not be determined from Target Warehouses.\"\r\n        )\r\n\r\n    # ❌ Do not allow multiple branches\r\n    if len(branches) > 1:\r\n        frappe.throw(\r\n            \"All items in a Material Transfer must belong to the same Branch \"\r\n            \"(based on Target Warehouse).\"\r\n        )\r\n\r\n    branch = branches.pop()\r\n\r\n    # Set Branch on Stock Entry (recommended)\r\n    doc.branch = branch\r\n\r\n    # Get Branch Abbreviation\r\n    branch_abbr = frappe.db.get_value(\r\n        \"Branch\",\r\n        branch,\r\n        \"custom_abbr\"\r\n    )\r\n\r\n    if not branch_abbr:\r\n        frappe.throw(\r\n            f\"Branch abbreviation (custom_abbr) is missing for Branch: {branch}\"\r\n        )\r\n\r\n    # Branch-wise Material Transfer Naming Series\r\n    if doc.stock_entry_type == \"Material Transfer\" :\r\n        doc.naming_series = f\"MT-{branch_abbr}-.YY.-.##\"\r\n    elif doc.stock_entry_type == \"Material Receipt\":\r\n        doc.naming_series = f\"MRE-{branch_abbr}-.YY.-.##\"\r\n        \r\n",
  "script_type": "DocType Event"
 }
]